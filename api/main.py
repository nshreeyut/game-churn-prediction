"""
FastAPI Application Entry Point
================================
This is where your API starts. FastAPI is a modern Python web framework that:
  - Automatically generates interactive API docs (visit /docs when running)
  - Validates request/response data using Python type hints
  - Supports async/await out of the box (important for LLM streaming)

To run locally:
  uvicorn api.main:app --reload --port 8000

Then visit:
  http://localhost:8000/docs  ← free interactive docs, auto-generated by FastAPI
  http://localhost:8000/health ← confirm the server is running
"""

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from api.routers import players, chat
from api.config import settings

# Create the FastAPI app instance.
# The title/description appear in your auto-generated /docs page.
app = FastAPI(
    title="Game Churn Prediction API",
    description="Predict and explain player churn across multiple gaming platforms.",
    version="1.0.0",
)

# ---------------------------------------------------------
# CORS (Cross-Origin Resource Sharing)
# ---------------------------------------------------------
# Your React app (localhost:5173 in dev, Vercel URL in prod) is a DIFFERENT
# origin than your API (localhost:8000 / Render URL).
# Without CORS, browsers block these cross-origin requests for security.
# This middleware says: "I allow requests from these specific origins."
#
# TODO: Before deploying, add your Vercel URL to settings.cors_origins in config.py.
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ---------------------------------------------------------
# Register Routers
# ---------------------------------------------------------
# Routers are modular groups of endpoints. Instead of defining every route
# in this one file, we split them by domain into api/routers/.
#
# prefix="/api/v1" means all routes are namespaced.
# So players.py's GET "/" becomes GET /api/v1/players.
# The "v1" lets you release a v2 later without breaking existing clients.
app.include_router(players.router, prefix="/api/v1/players", tags=["Players"])
app.include_router(chat.router, prefix="/api/v1/chat", tags=["Chat"])


@app.get("/health")
def health_check():
    """
    Health check endpoint.
    Render and other hosting platforms ping this URL to verify the app is alive.
    Keep it simple — just confirm the server is up.
    """
    return {"status": "ok"}
